#summary One-sentence summary of this page.

<wiki:toc max_depth="3" />

= 変更の目的 =

rtmros_commonのディレクトリを以下の目的のために整理します．(issue 137)

- catkinに対応し，bloomによるdebファイル生成がrosbuild firmでパッケージを作り易くする


= 今までのソースを使いたい人 =

今までのソースを使っていく人は以下の

{{{
svn co https://rtm-ros-robotics.googlecode.com/svn/tags/fuerte-3.1.4-20130727 rtmros_common
}}}

として使って下さい．このソースは以降更新はされませんが，変更が落ち着くまでの対処としておすすめします

= 新しいソースに移行したい人 =

== svn up のしかた ==

{{{
roscd rtmros_common/../../; mv rtm-ros-robotics/rtmros_common rtm-ros-robotics/rtmros_common.bak
# (tag/latestバージョンを使う人はtrunkをtags/latestに変更して下さい）
# rosws merge http://rtm-ros-robotics.googlecode.com/svn/tags/latest/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall  
rosws merge http://rtm-ros-robotics.googlecode.com/svn/trunk/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall  
rosws update
}}}
とクリーンチェックアウトして
{{{
rosmake hrpsys_ros_bridge
}}}
としてコンパイルすることをお勧めします

= 変更点とそれに対応して変更しなければいけないところ =

== パッケージの分割 ==

 *  openrtm を openrtm_aist, openrtm_aist_python, rtshell, rtctree, rtsprofile に分割しました．
  これらはupstreamのソースを落として（最低限のパッチを当てて）コンパイルするパッケージとし，ユーザがつくったスクリプト，テストなどは移行しました．
  -  rosrun openrtm rtm-naming とある部分は rosrun openrtm_aist rtm_namingに変更
   同様にrtm-config, rtm-skelwrapperもopenrtm_aistから使う（参考:r4713）

  - rtshell-setup.shについて
{{{
    openrtm/scripts/rtshell-setup.sh
}}}
ではなく，
{{{
    openrtm_tools/scripts/rtshell-setup.sh
}}}
を使って下さい．

== javaは未対応になりました ==

 * openrtm3/hrpsysでjavaのidl生成，eclipse/grxuiの利用を止めました（希望があれば復帰します）

  - 各実機用のロボットでhrpsys-baseのコンパイルをしているものは，前項の変更に伴いopenrtm_aistを利用できるようにし，かつ，javaのオプションをdisableする必要があります (参考：r4746)

== 便利スクリプトファイルの扱い ==

 * hrpsys/scripts openrtm/scripts　など追加したスクリプトは hrpsys_tools, openrtm_toolsに移行

  - luanch ファイルの修正
　　各launchファイルの
{{{
<include file="$(find hrpsys)/launch/hrpsys.launch" >
}}}
　は 
{{{
 <include file="$(find hrpsys_tools)/launch/hrpsys.launch" >
}}}
　に変更(参考:r4740）．

　変更するためのスクリプト
{{{
find . -name "*.launch" -exec sed -i "s#(findhrpsys)/launch/hrpsys.launch#(find hrpsys_tools)/launch/hrpsys.launch#" {} \;
}}}

 * hrpsys.pyはhrpsys_config.pyに名前を変更しました．
   hrpsys.py をhrpsys-baseに取り込む予定で．その場合はhrpsys.soにかぶるため．これにともんないユーザプログラムで，import hrpsysをimport hrpsys_configに変更が必要になります．（参考r4741)
   また，launchでHRPSYS_PY_PKGを設定して改造したhrpsysを使用している場合，自作のスクリプトの名前をhrpsys_config.pyとするか，HRPSYS_PY_NAMEをhrpsys.pyと設定する必要があります．

　　変更が必要なソース一覧の表示
{{{
        # test
        find . -name "*.py" -exec grep -l import\ hrpsys\$ {} \;
        find . -name "*.py" -exec grep -l from\ hrpsys\ import {} \; 
}}}

　ファイルを書き換えるスクリプト
{{{
        # change
        find . -name "*.py" -exec sed -i "s#^import hrpsys\$#import hrpsys_config#" {} \; -print
        find . -name "*.py" -exec sed -i "s#^from hrpsys import #from hrpsys_config import #" {} \; -print

}}}


== ブリッジコンポーネントについて ==

 * rtm-ros ブリッジコンポーネントの作成場所の変更

hrpsys, openrtm 以下ではrtm-ros ブリッジコンポーネントプログラムはつくられずhrpsys_ros_bridge以下で作成されるようになりました．したがって各自のソースコードで
{{{
  -#include "hrpsys/idl/RobotHardwareService.hh"
  +#include "hrpsys_ros_bridge/idl/RobotHardwareService.hh"
}}}
  と変更して下さい．（参考:r4741)

 * その他
  - KILL_SERVERSの廃止
{{{
   <arg name="KILL_SERVERS" default="$(arg KILL_SERVERS)" /> 
}}}
は廃止しました．各自のlaunchファイルから消して下さい．

= トラブルシュート =

* rtmが見つからない

roslaunch hrpsys_ros_bridge_tutorials hrp4c.launchすると、
{{{
  File "/home/tnakaoka/ros/fuerte/rtm-ros-robotics/rtmros_common/hrpsys_tools/scripts/hrpsys_config.py", line 5, in <module>
    import rtm
ImportError: No module named rtm
}}}

というエラーが出てhrpsys_config.pyが上がりません。

→　hrpsysディレクトリを一度削除してからsvn up hrpsys && rosmake hrpsysしたら直った気がします。

= ややこしいポイント =

hrpsys/lib/python2.7/dist-packages/hrpsys_config.py
と，
hrpsys_tools/scripts/hrpsys_config.py
があり，前者が今までつくっていたhrpsys_config.pyをコピーしたもの
後者は以下のようなダミーのプログラムです．
{{{
#!/usr/bin/env python
import roslib; roslib.load_manifest("hrpsys")

import sys
from hrpsys_config import HrpsysConfigurator

# copy from hrpsys/lib/python2.7/dist-packages/hrpsys_config.py
if __name__ == '__main__':
    hcf = HrpsysConfigurator()
    if len(sys.argv) > 2 :
        hcf.init(sys.argv[1], sys.argv[2])
    elif len(sys.argv) > 1 :
        hcf.init(sys.argv[1])
    else :
        hcf.init()
}}}
hrpsys_tools/scripts/hrpsys_config.py
がある理由は，hrpsysの下のhrpsys_config.pyはROSに依存しないという方針から
load_manifestをしていないため
rosrun hrpsys hrpsys_config.py
としても，PYTHONPATHを設定していないとimport RTCなどができないためです．

そこで，hrpsys_config.pyをスタンドアロンで立ち上げたい人は，
rosrun hrpsys_tools hrpsys_config.py
とします．これで，，行頭のload_manifest('hrpsys')で必要なPYTHONPATHを設定してからhrpsys_conifg.py
を読み込み実行します．