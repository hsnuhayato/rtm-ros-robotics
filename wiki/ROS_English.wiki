#summary OpenRTM-ROS Integration for Humanoid/Mobile Manipulator Robotics

<wiki:toc max_depth="3" />

= Install =

== Install source code ==
Install ROS by following [http://www.ros.org/wiki/electric/Installation/Ubuntu], install related ros packages and install `rtm-ros-robotics` software

{{{
wget https://jsk-ros-pkg.svn.sourceforge.net/svnroot/jsk-ros-pkg/trunk/jsk.rosbuild -O /tmp/jsk.rosbuild
bash /tmp/jsk.rosbuild --show-install | sh
bash /tmp/jsk.rosbuild --show-package | sh
}}}

For update installed packages 
{{{
rosinstall ~/prog/rtm-ros-robotics http://rtm-ros-robotics.googlecode.com/svn/tags/latest/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall
}}}

Load environment variables used for ROS system
{{{
source ~/prog/rtm-ros-robotics/setup.bash
}}}
Add this line to your ~/.bashrc

== Build source code ==
build source code and install related packages
{{{
$ rosmake --rosdep-install --rosdep-yes hrpsys_ros_bridge
}}}

If something seems to be wrong in rosmake, add --pre-clean option to cleanup all depend packages and make again.

If rosmake failed to install sun-java6-{jdk,fonts,plugin},
please install from Synaptic package manager.

When you use Ubuntu 11.04 or later and failed to make euslisp,
reboot and rosmake again.

== Setup Eclipse ==
type
{{{
$ rosrun openhrp3 eclipse.sh
}}}
then you'll see eclipse interface.
Then you select
`Help -> Install New Softare -> Add`
from menu bar. and add
 `http://download.eclipse.org/tools/gef/updates/releases/`
to the Location and uncheck "show only the latest version" .
Then GEF SDK 3.6.2 become available, install and restart eclipse.

You also need to add
 `http://download.eclipse.org/modeling/emf/updates/releases/`
to the Location and select EMF SDK 2.5.0.

Then select
`Help -> Install New Softare -> Add`
and press "Archive" button, and select the archive.

`<openhrp3>/build/rtmtools_eclipse.zip`

Then check everything to install.
`<openhrp3>` is a install directory for openhrp3. (roscd openhrp3)

Lastly, you have to install following software as well from Install
`New Software -> Add`

`<openhrp3>/build/java3declipse-20090302.zip`<br>
`<openhrp3>/build/grxui_eclipse.zip`<br>
`<hrpsys>/build/robothardware_eclipse.zip`<br>

= Example =
== OpenHRP3 Simulation ===

=== Falling Boxes ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/faling-boxes.launch faling-boxes.launch])
{{{
roslaunch openhrp3 falling-box.launch
}}}
press `Start Simulation` button 

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/FallingBoxes.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/FallingBoxes.png]

=== PA10 ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/pa10.launch pa10.launch])
{{{
roslaunch openhrp3 p10.launch
}}}
press `Start Simulation` button 

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/PA10Sample.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/PA10Sample.png]

=== Sample Vehicle ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/sample-vehicle.launch sample-vehicle.launch])
{{{
roslaunch openhrp3 sample-vehicle.launch
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleSV_RangeSensor.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleSV_RangeSensor.png]

=== Sample Humanoid Robot ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/samplerobot-walk.launch samplerobot-walk.launch]) 

Launch following launch script and press `Start Simulation` button 

{{{
roslaunch openhrp3 samplerobot-walk.launch
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SamplePD.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SamplePD.png]

([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/samplerobot-pickupbox.launch samplerobot-pickupbox.launch]) 

{{{
roslaunch openhrp3 samplerobot-pickupbox.launch
}}}
[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleLF.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleLF.png]

([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/samplerobot-inhouse.launch samplerobot-inhouse.launch])

{{{
roslaunch openhrp3 samplerobot-inhouse.launch
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleRobot_inHouse.png http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleRobot_inHouse.mp4]

Change FPS from 50 to 1-10 to speed up simulation.

== hrpsys Simulation ==

=== PA10 ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys/launch/pa10.launch pa10.launch])
{{{
roslaunch hrpsys pa10.launch
}}}
press `Start Simulation` button,
then press `execute script file` or `roscd hrpsys/share/hrpsys/samples/PA10; rosrun hrpsys hrpsyspy ./PA10.py`

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/PA10.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/PA10.png]

=== HRP-4C walking ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys/launch/hrp4c.launch hrp4c.launch])
{{{
roslaunch hrpsys hrp4c.launch
}}}
press `Start Simulation` button,
then press `execute script file` or command `roscd hrpsys/share/hrpsys/samples/HRP-4C; rosrun hrpsys hrpsyspy ./HRP4C.py` in new terminal

If failed to load HRP-4C model, rosmake hrpsys_ros_bridge again.

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/HRP4C.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/HRP4C.png]

=== Sample Robot Walking and Grasping ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys/launch/samplerobot.launch samplerobot.launch])
{{{
roslaunch hrpsys samplerobot.launch
}}}
press `Start Simulation` button,
then press `execute script file` or type
{{{
rosrun hrpsys hrpsyspy `rospack find hrpsys`/scripts/hrpsys.py `rospack find hrpsys`/scripts/SampleRobot_inHouse.xml
}}}
to start controller, then
{{{
rosrun hrpsys SampleRobot_walk.sh
}}}
to start walking.

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/SampleRobot.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/SampleRobot.png]

== RTM/ROS Integration ===

=== Sample Robot ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys_ros_bridge/launch/samplerobot.launch samplerobot.launch])
{{{
roslaunch hrpsys_ros_bridge samplerobot.launch
}}}
and if you see sample robot in RViz viewer, 
Then type
{{{
rosrun hrpsys SampleRobot_walk.sh
}}}
or
{{{
roscd hrpsys_ros_bridge/scripts/
rosrun roseus roseus samplerobot-pickup.l
}}}

If you do not need dynamics simulation, start `samplerobot.launch` with `--nosim` argument as followings:
{{{
roslaunch hrpsys_ros_bridge samplerobot.launch SCHEDULER_ARGS:=--nosim
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/samplerobot_rviz.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/samplerobot_rviz.png]

=== HRP4 ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys_ros_bridge/launch/hrp4c.launch hrp4c.launch])
{{{
roslaunch hrpsys_ros_bridge hrp4c.launch
}}}
to setup simulator and rviz viewer. Sample client program is
{{{
rosrun hrpsys hrp4c_walk.sh 
}}}
or
{{{
rosrun roseus roseus `rospack find hrpsys_ros_bridge`/scripts/hrp4c-pickup.l
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hrp4c_rviz.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hrp4c_rviz.png]

Note: when `rosrun hrpsys hrpsyspy ./HRP4C.py` does not work. 
you need to change  `bridge = findRTC("HRP-4C(Robot)0")` to `bridge = findRTC("HRP4(Robot)0")` and pass absolute path of "data/walk2m" to `loadPattern` function

=== Kawada HIRONX ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys_ros_bridge/launch/hironx.launch hironx.launch])
{{{
$ roslaunch hrpsys_ros_bridge hironx.launch
}}}
to launch rviz viewer with Kawada HiroNx robot

then, type
{{{
$ roscd hrpsys_ros_bridge/scrips; rosrun roseus roseus  kawada-hironx-example.l
}}}
to  see the robot is moving.

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hironx_rviz.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hironx_rviz.png]

= Troubleshooting =

== Check OmniORB bug ==
{{{
$ rosrun openrtm rtm-naming-restart
}}}
and start following command from different terminal
{{{
$ rosrun openhrp3 openhrp-aist-dynamics-simulator -ORBInitRef
NameService=corbaloc:iiop:localhost:2809/NameService
}}}
If you see "ready", than it ok,
if you see "IDL:omg.org/CORBA/TRANSIENT:1.0", that's would be omniorb
bug in ubuntu package.

Please comment out
{{{
::1     localhost ip6-localhost ip6-loopback
}}}
line from `/etc/hosts` file

== Check SVN version ==
make sure that you have downloaded latest version of repository 
{{{
$ roscd rtmros_common; svn up
}}}
if you have find any update, then `rosmake hrpsys hrpsys_ros_bridge` again

== Check Java version ==
OpenHRP3 assume SUN version of java and not GNU or other implementation.
{{{
$ java -version
  java version "1.6.0_26"
 Java(TM) SE Runtime Environment (build 1.6.0_26-b03)
 Java HotSpot(TM) 64-Bit Server VM (build 20.1-b02, mixed mode)
}}}
if it is not sun java, `rosdep install openhrp3` or `sudo
update-java-alternatives -s java-6-sun`

== Check OpenHRP simulation == 
Please make sure that OpenHRP simulation works.

{{{
$ rosrun openhrp3 grxui.sh
}}}
select "GrxUI -> Load Project" menu
and select FallingBoxes.xml
Then press "Start Simulation" button, to see if the 3 yellow boxes falling down.

Then select SampleRobot_inHouse.xml file and press "Start Simulation"
button to see that robot start walking.

If this not working, you may fail to install eclipse plugin
{{{
rm -fr ~/.eclipse
roscd openhrp3; rm -fr workspace
}}}
and then [http://code.google.com/p/rtm-ros-robotics/wiki/ROS_English#Setup_Eclipse setup eclipse to install the plugins] again.

== Check HiroNX collada file ==
Make sure that you have downloaded HiroNX collada file
{{{
 rosls collada_robots/data/robots/kawada-hironx.dae
}}}

if not, `roscd collada_robots; rm installed; make`

== Check OpenHRP Collada support ==
Make sure that your openrhp3 support to load collada files
{{{
$ roslaunch openhrp3 grxui.launch
}}}
and right click Model menu on the left "Item View" and select "load",

Select kawada-hironx.dae under
jsk-ros-pkg/openrave_planning/collada_robots/data/robots  directory

Select `*.dae` from buttom left menu, that currently shown as `*.wrl`, and
choose kawada-hironx.dae model, then confurm if you can see kawada
robot model on the screen.