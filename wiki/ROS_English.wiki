#summary OpenRTM-ROS Integration for Humanoid/Mobile Manipulator Robotics

<wiki:toc max_depth="3" />

= Install =

== Install source code ==
Install ROS by following [http://www.ros.org/wiki/fuerte/Installation/Ubuntu], 

Make sure sun-java-jrk is installed and that it is the default java distribution chosen for your PC 
{{{
#add repository
$ sudo apt-add-repository ppa:flexiondotorg/java
$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 2EA8F35793D8809A
$ sudo apt-get update
# install java 
$ sudo apt-get install sun-java6-jdk sun-java6-jre sun-java6-plugin
# select the sun distribution as default using commands
$ sudo update-alternatives --config java
$ sudo update-alternatives --config javac
# check it is the default
$ java -version
}}}

If you use Ubuntu 12.04, try below installation.
{{{
$ mkdir ~/src
$ cd ~/src
$ git clone https://github.com/flexiondotorg/oab-java6.git
$ cd ~/src/oab-java6
$ sudo ./oab-java.sh
$ sudo apt-get install sun-java6-plugin sun-java6-jre sun-java6-bin sun-java6-jdk
$ sudo update-java-alternatives -s java-6-sun 
## reference: http://www.gaggl.com/2012/04/installing-java6-jdk-on-ubuntu-12-04/
}}} 

install related ros packages and install `rtm-ros-robotics` software

{{{
wget 'https://sourceforge.net/p/jsk-ros-pkg/code/HEAD/tree/trunk/jsk.rosbuild?format=raw' -O /tmp/jsk.rosbuild
yes | bash /tmp/jsk.rosbuild
cd ~/ros/fuerte
source setup.bash
rosws merge http://rtm-ros-robotics.googlecode.com/svn/tags/latest/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall -ry
rosws update
}}}

For update installed packages 
{{{
cd ~/ros/fuerte
rosws merge http://rtm-ros-robotics.googlecode.com/svn/tags/latest/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall -ry
rosws update
}}}

Note: If you are a committer, you should use 'http://rtm-ros-robotics.googlecode.com/svn/trunk/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall' instead of 'http://rtm-ros-robotics.googlecode.com/svn/tags/latest/agentsystem_ros_tutorials/rtm-ros-robotics.rosinstall'.

Load environment variables used for ROS system
{{{
source ~/ros/fuerte/setup.bash
}}}
Add this line to your ~/.bashrc

== Build source code ==
build source code and install related packages
{{{
$ rosdep install hrpsys_ros_bridge_tutorials
$ rosmake hrpsys_ros_bridge_tutorials
}}}

If something seems to be wrong in rosmake, add --pre-clean option to cleanup all depend packages and make again.

If rosmake failed to install sun-java6-{jdk,fonts,plugin},
please install from Synaptic package manager.

When you use Ubuntu 11.04 or later and failed to make euslisp as follows,
reboot and rosmake again.
{{{
  can't load font "*-courier-medium-r-*-8-*"can't load font "*-courier-medium-r-*-10-*"can't load font "*-courier-medium-r-*-12-*"can't load font "*-courier-medium-r-*-14-*"can't load font "*-courier-medium-r-*-18-*"can't load font "*-courier-bold-r-*-12-*"can't load font "*-courier\
-bold-r-*-14-*"can't load font "*-courier-bold-r-*-18-*"can't load font "*-courier-bold-r-*-24-*"can't load font "*-times-medium-r-*-10-*"can't load font "*-times-medium-r-*-12-*"can't load font "*-times-bold-r-*-12-*"can't load font "*-times-bold-r-*-14-*"can't load font "*-times-b\
old-r-*-18-*"can't load font "*-times-bold-r-*-24-*"can't load font "lucidasans-bold-12"can't load font "lucidasans-bold-14"can't load font "*-Helvetica-Bold-R-Normal-*-12-*"can't load font "*-Helvetica-Medium-R-Normal-*-12-*"X Error of failed request:  BadFont (invalid Font paramet\
er)
    Major opcode of failed request:  56 (X_ChangeGC)
    Resource id in failed request:  0x0
    Serial number of failed request:  49
    Current serial number in output stream:  58
}}}

If the problem persists, install fonts:

{{{
sudo apt-get install -y gsfonts-x11 texlive-fonts-extra xfonts-100dpi xfonts-75dpi xfonts-100dpi-transcoded xfonts-75dpi-transcoded
}}}


== Setup Eclipse ==
type
{{{
$ rosrun openhrp3 install-eclipse-plugins.sh
}}}
and wait for several minutes.

Note: You must comment out the line "::1 localhost" in /etc/hosts to run following simulations.

= Before executing Example =
=== For ROS ===
invoke roscore: (this can be ommitted)
{{{
roscore
}}}
You can ommit invoking roscore because the first roslaunch process starts up ROS_MASTER. 

= Example =
== OpenHRP3 Simulation ===

=== Falling Boxes ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/faling-boxes.launch faling-boxes.launch])
{{{
roslaunch openhrp3 falling-box.launch
}}}
press `Start Simulation` button 

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/FallingBoxes.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/FallingBoxes.png]

=== PA10 ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/pa10.launch pa10.launch])
{{{
roslaunch openhrp3 pa10.launch
}}}
press `Start Simulation` button 

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/PA10Sample.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/PA10Sample.png]

=== Sample Vehicle ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/sample-vehicle.launch sample-vehicle.launch])
{{{
roslaunch openhrp3 sample-vehicle.launch
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleSV_RangeSensor.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleSV_RangeSensor.png]

=== Sample Humanoid Robot ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/samplerobot-walk.launch samplerobot-walk.launch]) 

Launch following launch script and press `Start Simulation` button 

{{{
roslaunch openhrp3 samplerobot-walk.launch
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SamplePD.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SamplePD.png]

([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/samplerobot-pickupbox.launch samplerobot-pickupbox.launch]) 

{{{
roslaunch openhrp3 samplerobot-pickupbox.launch
}}}
[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleLF.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleLF.png]

([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/openhrp3/launch/samplerobot-inhouse.launch samplerobot-inhouse.launch])

{{{
roslaunch openhrp3 samplerobot-inhouse.launch
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleRobot_inHouse.png http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/openhrp3-example/_images/SampleRobot_inHouse.mp4]

Change FPS from 50 to 1-10 to speed up simulation.

== hrpsys Simulation ==

=== PA10 ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys/launch/pa10.launch pa10.launch])
{{{
roslaunch hrpsys pa10.launch
}}}
press `Start Simulation` button,
then press `execute script file` or `roscd hrpsys/share/hrpsys/samples/PA10; rosrun hrpsys hrpsyspy ./PA10.py`

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/PA10.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/PA10.png]

=== HRP-4C walking ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys/launch/hrp4c.launch hrp4c.launch])
{{{
roslaunch hrpsys hrp4c.launch
}}}
press `Start Simulation` button,
then press `execute script file` or command `roscd hrpsys/share/hrpsys/samples/HRP-4C; rosrun hrpsys hrpsyspy ./HRP4C.py` in new terminal

If failed to load HRP-4C model, rosmake hrpsys_ros_bridge again.

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/HRP4C.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/HRP4C.png]

=== Sample Robot Walking and Grasping ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys/launch/samplerobot.launch samplerobot.launch])
{{{
roslaunch hrpsys samplerobot.launch
}}}
press `Start Simulation` button,
then press `execute script file` or type
{{{
rosrun hrpsys hrpsyspy `rospack find hrpsys`/scripts/hrpsys.py `rospack find hrpsys`/scripts/SampleRobot_inHouse.xml
}}}
to start controller, then
{{{
rosrun hrpsys SampleRobot_walk.sh
}}}
to start walking.

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/SampleRobot.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys-example/_images/SampleRobot.png]

== RTM/ROS Integration ===

=== Sample Robot ===
* simple demonstration
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys_ros_bridge/launch/samplerobot.launch samplerobot.launch])
{{{
rtmlaunch hrpsys_ros_bridge_tutorials samplerobot.launch
}}}
and if you see sample robot in RViz viewer, 
{{{
roscd hrpsys_ros_bridge_tutorials/euslisp/
rosrun roseus roseus samplerobot-pickup.l
}}}

If you do not need dynamics simulation, start `samplerobot_nosim.launch`:
{{{
rtmlaunch hrpsys_ros_bridge_tutorials samplerobot_nosim.launch
}}}
* keyboard interactive teleop example
{{{
rtmlaunch hrpsys_ros_bridge_tutorials samplerobot.launch LAUNCH_TELEOP:=true
}}}
and if you see "teleop_pr2_keyboard" terminal, 
Then type
{{{
# walking pattern generation example using euslisp
roscd hrpsys_ros_bridge_tutorials/euslisp/
rosrun roseus roseus samplerobot-walk.l
(samplerobot-walk) ;; on euslisp prompt, setting target pos+rot example
(samplerobot-walk2) ;; on euslisp prompt, keyboard teleop sample
}}}



[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/samplerobot_rviz.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/samplerobot_rviz.png]

=== HRP4 ===
!!HRP4 example is currently not supported!!
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys_ros_bridge/launch/hrp4c.launch hrp4c.launch])
{{{
rtmlaunch hrpsys_ros_bridge_tutorials hrp4c.launch
}}}
to setup simulator and rviz viewer. Sample client program is
{{{
rosrun hrpsys hrp4c_walk.sh 
}}}
or
{{{
rosrun roseus roseus `rospack find hrpsys_ros_bridge_tutorials`/euslisp/hrp4c-pickup.l
}}}

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hrp4c_rviz.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hrp4c_rviz.png]

Note: when `rosrun hrpsys hrpsyspy ./HRP4C.py` does not work. 
you need to change  `bridge = findRTC("HRP-4C(Robot)0")` to `bridge = findRTC("HRP4(Robot)0")` and pass absolute path of "data/walk2m" to `loadPattern` function

=== Kawada HIRONX ===
([http://code.google.com/p/rtm-ros-robotics/source/browse/tags/latest/rtmros_common/hrpsys_ros_bridge/launch/hironx.launch hironx.launch])
{{{
$ roslaunch hrpsys_ros_bridge_tutorials hironx_nosim.launch
}}}
to launch rviz viewer with Kawada HiroNx robot, without hrpsys-simulator's dynamics simulation

then, type
{{{
$ roscd hrpsys_ros_bridge_tutorials/euslisp; rosrun roseus roseus  kawada-hironx-example.l
}}}
to  see the robot is moving.

[http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hironx_rviz.mp4 http://jenkins.jsk.imi.i.u-tokyo.ac.jp:8080/job/agentsystem-test/lastStableBuild/artifact/hrpsys_ros_bridge-example/_images/hironx_rviz.png]

=== Adding optional environments or object models ===
If you want to add optional environments and object models, 
please generate Project File (XXX.xml). 
{{{
 rostest -t hrpsys _gen_project.launch INPUT:=`rospack find openhrp3`/share/OpenHRP-3.1/sample/model/sample1.wrl OUTPUT:=`rospack find hrpsys_ros_bridge_tutorials`/models/SampleRobot.xml OBJECT_MODELS:="`rospack find openhrp3`/share/OpenHRP-3.1/sample/model/longfloor.wrl `rospack find openhrp3`/share/OpenHRP-3.1/sample/model/house/table.wrl,-0.3,0.5,0,1,0,0,1.5708"
}}}
then, 
{{{
roslaunch hrpsys_ros_bridge_tutorials samplerobot.launch 
}}}
gen_project.launch is called in CMakeLists in hrpsys_ros_bridge_tutorials.
Therefore, default project files are generated when "rosmake hrpsys_ros_bridge_tutorials". 

roslaunch arguments are:

- INPUT <- robot model file (.wrl)

- OUTPUT <- output file name for ProjectFile (.xml) and conf file (.conf)

- OBJECT_MODELS <- optional argument. Please set object & environment model file (wrl). longfloor.wrl are specified by default.

If you want to specify origin offset of added model files, 
{{{
`rospack find openhrp3`/share/OpenHRP-3.1/sample/model/house/table.wrl,-0.3,0.5,0,1,0,0,1.5708
}}}
please add offset values after specifying wrl file by using camma. 

-0.3,0.5,0 <- position offset (m)

1,0,0,1.5708 <- orientation offset (axis and angle)


= Troubleshooting =

== Check OmniORB bug ==
{{{
$ rosrun openrtm rtm-naming-restart
}}}
and start following command from different terminal
{{{
$ rosrun openhrp3 openhrp-aist-dynamics-simulator -ORBInitRef NameService=corbaloc:iiop:localhost:2809/NameService
}}}
If you see "ready", than it ok,
if you see "IDL:omg.org/CORBA/TRANSIENT:1.0", that's would be omniorb
bug in ubuntu package.

Please comment out
{{{
::1     localhost ip6-localhost ip6-loopback
}}}
line from `/etc/hosts` file

== Check SVN version ==
make sure that you have downloaded latest version of repository 
{{{
$ roscd rtmros_common; svn up
}}}
if you have find any update, then `rosmake hrpsys hrpsys_ros_bridge` again

== Check Java version ==
OpenHRP3 assume SUN version of java and not GNU or other implementation.
{{{
$ java -version
  java version "1.6.0_26"
 Java(TM) SE Runtime Environment (build 1.6.0_26-b03)
 Java HotSpot(TM) 64-Bit Server VM (build 20.1-b02, mixed mode)
}}}
if it is not sun java, `rosdep install openhrp3` or `sudo
update-java-alternatives -s java-6-sun`

== Check OpenHRP simulation == 
Please make sure that OpenHRP simulation works.

{{{
$ rosrun openhrp3 grxui.sh
}}}
select "GrxUI -> Load Project" menu
and select FallingBoxes.xml
Then press "Start Simulation" button, to see if the 3 yellow boxes falling down.

Then select SampleRobot_inHouse.xml file and press "Start Simulation"
button to see that robot start walking.

If this not working, you may fail to install eclipse plugin
{{{
rm -fr ~/.eclipse
roscd openhrp3; rm -fr workspace
}}}
and then [http://code.google.com/p/rtm-ros-robotics/wiki/ROS_English#Setup_Eclipse setup eclipse to install the plugins] again.

== Check HiroNX collada file ==
Make sure that you have downloaded HiroNX collada file
{{{
 rosls collada_robots/data/robots/kawada-hironx.dae
}}}

if not, `roscd collada_robots; rm installed; make`

== Check OpenHRP Collada support ==
Make sure that your openrhp3 support to load collada files
{{{
$ rosrun openhrp3 grxui.sh
}}}
and right click Model menu on the left "Item View" and select "load",

Select kawada-hironx.dae under
jsk-ros-pkg/openrave_planning/collada_robots/data/robots  directory

Select `*.dae` from buttom left menu, that currently shown as `*.wrl`, and
choose kawada-hironx.dae model, then confurm if you can see kawada
robot model on the screen.